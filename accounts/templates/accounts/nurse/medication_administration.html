{% extends "base.html" %}

{% block content %}
<div class="nurse-container" style="background-color: #f5faf5; min-height: 100vh; padding: 20px;">
    <div class="card" style="border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
        <div class="card-header" style="background-color: #27ae60; color: white; border-radius: 10px 10px 0 0; padding: 15px 20px;">
            <div class="d-flex justify-content-between align-items-center">
                <h2 style="margin: 0;"><i class="fas fa-syringe"></i> Journal d'Administration</h2>
                <select id="patientSelect" class="form-select" style="width: 300px; background-color: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">
                    <option value="">Sélectionnez un patient...</option>
                    {% for p in patients %}
                    <option value="{{ p.id }}" {% if p.id == patient.id %}selected{% endif %}>{{ p.get_full_name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="card-body" style="padding: 0;">
            {% if patient %}
            <div class="patient-info" style="background-color: #f8f9fa; padding: 15px 20px; border-bottom: 1px solid #eee;">
                <div class="d-flex align-items-center">
                    <div class="patient-avatar" style="margin-right: 15px;">
                        <i class="fas fa-user-circle" style="font-size: 3em; color: #27ae60;"></i>
                    </div>
                    <div>
                        <h3 style="margin: 0; color: #2c3e50;">{{ patient.get_full_name }}</h3>
                        <div style="display: flex; gap: 15px; margin-top: 5px;">
                            <span style="color: #7f8c8d;"><i class="fas fa-id-badge"></i> {{ patient.id_number }}</span>
                            <span style="color: #7f8c8d;"><i class="fas fa-bed"></i> Chambre {{ patient.room_number|default:"N/A" }}</span>
                            <span style="color: #7f8c8d;"><i class="fas fa-user-md"></i> Dr. {{ patient.patient_record.primary_doctor.get_full_name }}</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="medication-content" style="padding: 20px;">
                {% if patient %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4" style="border: 1px solid #e0e0e0; border-radius: 8px;">
                                <div class="card-header" style="background-color: #e8f5e9; border-bottom: 1px solid #e0e0e0;">
                                    <h5 class="mb-0"><i class="fas fa-clock"></i> À Administrer</h5>
                                </div>
                                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                    {% if pending_meds %}
                                        {% for med in pending_meds %}
                                        <div class="medication-item mb-3 p-3" style="border: 1px solid #eee; border-radius: 6px; background-color: #fff8e1;">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <h6 style="color: #d35400; margin-bottom: 5px;">{{ med.medication.name }}</h6>
                                                    <p style="margin-bottom: 5px;"><strong>Dose:</strong> {{ med.medication.dosage }}</p>
                                                    <p style="margin-bottom: 5px;"><strong>Heure prévue:</strong> {{ med.scheduled_time|time }}</p>
                                                </div>
                                                <button class="btn btn-sm btn-success administer-btn" 
                                                        data-medication-id="{{ med.id }}"
                                                        style="background-color: #27ae60; border: none;">
                                                    <i class="fas fa-syringe"></i>
                                                </button>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="text-center py-3">
                                            <i class="fas fa-check-circle" style="font-size: 2em; color: #27ae60;"></i>
                                            <p class="mt-2">Tous les médicaments ont été administrés</p>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card" style="border: 1px solid #e0e0e0; border-radius: 8px;">
                                <div class="card-header" style="background-color: #e8f5e9; border-bottom: 1px solid #e0e0e0;">
                                    <h5 class="mb-0"><i class="fas fa-history"></i> Historique</h5>
                                </div>
                                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                    {% if administered_meds %}
                                        {% for med in administered_meds %}
                                        <div class="medication-item mb-3 p-3" style="border: 1px solid #eee; border-radius: 6px; background-color: #e8f5e9;">
                                            <h6 style="color: #27ae60; margin-bottom: 5px;">{{ med.medication.name }}</h6>
                                            <p style="margin-bottom: 5px;"><strong>Dose:</strong> {{ med.medication.dosage }}</p>
                                            <p style="margin-bottom: 5px;"><strong>Administré à:</strong> {{ med.administered_time|time }} par {{ med.administered_by.get_full_name }}</p>
                                            {% if med.notes %}
                                            <div class="notes" style="background-color: white; padding: 8px; border-radius: 4px; margin-top: 5px;">
                                                <p style="margin-bottom: 0;"><strong>Notes:</strong> {{ med.notes }}</p>
                                            </div>
                                            {% endif %}
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="text-center py-3">
                                            <i class="fas fa-history" style="font-size: 2em; color: #7f8c8d;"></i>
                                            <p class="mt-2">Aucun médicament administré récemment</p>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% else %}
                <div class="alert alert-warning" style="background-color: #fff8e1; color: #ff8f00; border-color: #ffecb3;">
                    <i class="fas fa-exclamation-triangle"></i> Veuillez sélectionner un patient pour voir son journal d'administration.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal d'administration -->
<div class="modal fade" id="administerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #27ae60; color: white;">
                <h5 class="modal-title"><i class="fas fa-syringe"></i> Confirmer l'administration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
            </div>
            <form id="administerForm" method="post" action="{% url 'administer_medication' %}">
                <div class="modal-body">
                    {% csrf_token %}
                    <input type="hidden" name="medication_id" id="medicationId">
                    
                    <div class="mb-3">
                        <label for="administer_time" class="form-label">Heure réelle d'administration</label>
                        <input type="time" class="form-control" name="administer_time" id="administer_time" required value="{% now 'H:i' %}">
                    </div>
                    
                    <div class="mb-3">
                        <label for="administer_notes" class="form-label">Notes</label>
                        <textarea class="form-control" name="administer_notes" id="administer_notes" rows="3" placeholder="Réaction du patient, observations..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times"></i> Annuler</button>
                    <button type="submit" class="btn btn-success"><i class="fas fa-check"></i> Confirmer</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.getElementById('patientSelect').addEventListener('change', function() {
    const patientId = this.value;
    if (patientId) {
        window.location.href = `/nurse/medication-administration/?patient_id=${patientId}`;
    }
});

document.querySelectorAll('.administer-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const medicationId = this.dataset.medicationId;
        document.getElementById('medicationId').value = medicationId;
        
        // Initialiser le modal Bootstrap
        const modal = new bootstrap.Modal(document.getElementById('administerModal'));
        modal.show();
    });
});
</script>
{% endblock %}